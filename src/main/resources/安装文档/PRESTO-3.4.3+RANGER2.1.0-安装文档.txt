
##################################################################
presto3.3.3开始需要jdk11，ranger需要2.1.0以上才开始支持jdk11
注意版本

1.安装RANGER2.1.0
参考《RANGER2.0.0安装.txt》其中只是多了ELASTICSEARCH配置

2.安装PRESTO-SQL
参考《PRESTO-SQL-安装.txt》

3.配置ranger-presto
>tar -zxvf ranger-2.1.0-presto-plugin.tar.gz -C /opt
>cd /opt
>ln -s ranger-2.1.0-presto-plugin ranger-presto
>vi ranger-presto/install.properties
XAAUDIT.SUMMARY.ENABLE=false

POLICY_MGR_URL=http://mdw1:6080

REPOSITORY_NAME=prestodev

COMPONENT_INSTALL_DIR_NAME=/opt/presto

XAAUDIT.SOLR.ENABLE=true
XAAUDIT.SOLR.URL=http://mdw1:6083/solr/ranger_audits
XAAUDIT.SOLR.USER=slor
XAAUDIT.SOLR.PASSWORD=slor
XAAUDIT.SOLR.ZOOKEEPER=mdw1:2181,sdw1:2181,sdw2:2181/ranger_audits
XAAUDIT.SOLR.FILE_SPOOL_DIR=/opt/ranger-presto/log

XAAUDIT.ELASTICSEARCH.ENABLE=false
XAAUDIT.ELASTICSEARCH.URL=NONE
XAAUDIT.ELASTICSEARCH.USER=NONE
XAAUDIT.ELASTICSEARCH.PASSWORD=NONE
XAAUDIT.ELASTICSEARCH.INDEX=NONE
XAAUDIT.ELASTICSEARCH.PORT=NONE
XAAUDIT.ELASTICSEARCH.PROTOCOL=NONE

XAAUDIT.HDFS.ENABLE=false
XAAUDIT.HDFS.HDFS_DIR=hdfs://__REPLACE__NAME_NODE_HOST:8020/ranger/audit
XAAUDIT.HDFS.FILE_SPOOL_DIR=/var/log/presto/audit/hdfs/spool

XAAUDIT.HDFS.AZURE_ACCOUNTNAME=__REPLACE_AZURE_ACCOUNT_NAME
XAAUDIT.HDFS.AZURE_ACCOUNTKEY=__REPLACE_AZURE_ACCOUNT_KEY
XAAUDIT.HDFS.AZURE_SHELL_KEY_PROVIDER=__REPLACE_AZURE_SHELL_KEY_PROVIDER
XAAUDIT.HDFS.AZURE_ACCOUNTKEY_PROVIDER=__REPLACE_AZURE_ACCOUNT_KEY_PROVIDER

XAAUDIT.LOG4J.ENABLE=false
XAAUDIT.LOG4J.IS_ASYNC=false
XAAUDIT.LOG4J.ASYNC.MAX.QUEUE.SIZE=10240
XAAUDIT.LOG4J.ASYNC.MAX.FLUSH.INTERVAL.MS=30000
XAAUDIT.LOG4J.DESTINATION.LOG4J=true
XAAUDIT.LOG4J.DESTINATION.LOG4J.LOGGER=xaaudit

XAAUDIT.HDFS.IS_ENABLED=false
XAAUDIT.HDFS.DESTINATION_DIRECTORY=hdfs://__REPLACE__NAME_NODE_HOST:8020/ranger/audit/%app-type%/%time:yyyyMMdd%
XAAUDIT.HDFS.LOCAL_BUFFER_DIRECTORY=__REPLACE__LOG_DIR/presto/audit
XAAUDIT.HDFS.LOCAL_ARCHIVE_DIRECTORY=__REPLACE__LOG_DIR/presto/audit/archive

XAAUDIT.HDFS.DESTINTATION_FILE=%hostname%-audit.log
XAAUDIT.HDFS.DESTINTATION_FLUSH_INTERVAL_SECONDS=900
XAAUDIT.HDFS.DESTINTATION_ROLLOVER_INTERVAL_SECONDS=86400
XAAUDIT.HDFS.DESTINTATION_OPEN_RETRY_INTERVAL_SECONDS=60
XAAUDIT.HDFS.LOCAL_BUFFER_FILE=%time:yyyyMMdd-HHmm.ss%.log
XAAUDIT.HDFS.LOCAL_BUFFER_FLUSH_INTERVAL_SECONDS=60
XAAUDIT.HDFS.LOCAL_BUFFER_ROLLOVER_INTERVAL_SECONDS=600
XAAUDIT.HDFS.LOCAL_ARCHIVE_MAX_FILE_COUNT=10

XAAUDIT.SOLR.IS_ENABLED=true
XAAUDIT.SOLR.MAX_QUEUE_SIZE=1
XAAUDIT.SOLR.MAX_FLUSH_INTERVAL_MS=1000
XAAUDIT.SOLR.SOLR_URL=http://mdw1:6083/solr/ranger_audits

SSL_KEYSTORE_FILE_PATH=/opt/ranger-presto/conf/ranger-plugin-keystore.jks
SSL_KEYSTORE_PASSWORD=myKeyFilePassword
SSL_TRUSTSTORE_FILE_PATH=/opt/ranger-presto/conf/ranger-plugin-truststore.jks
SSL_TRUSTSTORE_PASSWORD=changeit
CUSTOM_USER=hive
CUSTOM_GROUP=hadoop


>cd ranger-presto
>./enable-presto-plugin.sh


4.因为开启了 kerberos 这里需要ranger中hadoopjar配置之


编辑$PRESTO_HOME/plugin/ranger/ranger-presto-plugin-impl/hadoop-common-3.1.1.jar将集群的core-site.xml放在jar包根目录

keytool -genkeypair -alias presto -keyalg RSA -keystore keystore.jks
#其中 CN = *.presto.com
#这里必须使用通配符,所以使用node.internal-address=mdw1.presto.com来指定hostname,配置/etc/hosts来实现域名方式的机器名字

172.16.15.82 mdw1
172.16.15.83 sdw1
172.16.15.84 sdw2

172.16.15.82 mdw1.presto.com
172.16.15.83 sdw1.presto.com
172.16.15.84 sdw2.presto.com





